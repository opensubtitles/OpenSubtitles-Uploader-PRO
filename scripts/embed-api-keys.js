#!/usr/bin/env node

import fs from 'fs';
import path from 'path';

/**
 * Embed API keys at compile time for production builds
 * This script generates a constants file with embedded API keys
 */

const EMBEDDED_CONSTANTS_FILE = 'src/utils/embeddedConstants.js';

// API Keys to embed (from environment variables)
const API_KEYS = {
  OPENSUBTITLES_API_KEY: process.env.OPENSUBTITLES_API_KEY || process.env.VITE_OPENSUBTITLES_API_KEY || '',
  // Add other API keys here if needed
};

// Generate the embedded constants file
function generateEmbeddedConstants() {
  const timestamp = new Date().toISOString();
  
  const content = `// Generated at compile time: ${timestamp}
// DO NOT EDIT THIS FILE MANUALLY - Generated by scripts/embed-api-keys.js

/**
 * Embedded API Constants
 * These are embedded at compile time for production builds
 */

// Embedded API Keys
export const EMBEDDED_OPENSUBTITLES_API_KEY = '${API_KEYS.OPENSUBTITLES_API_KEY}';

// Build information
export const BUILD_TIMESTAMP = '${timestamp}';
export const HAS_EMBEDDED_KEYS = ${!!API_KEYS.OPENSUBTITLES_API_KEY};

// Validation
export const validateEmbeddedKeys = () => {
  const errors = [];
  
  if (!EMBEDDED_OPENSUBTITLES_API_KEY) {
    errors.push('OpenSubtitles API key not embedded at compile time');
  }
  
  return {
    isValid: errors.length === 0,
    errors,
    hasEmbeddedKeys: HAS_EMBEDDED_KEYS
  };
};

// Get embedded API key with fallback
export const getEmbeddedApiKey = () => {
  return EMBEDDED_OPENSUBTITLES_API_KEY || '';
};

console.log('üì¶ Embedded constants loaded:', {
  hasApiKey: !!EMBEDDED_OPENSUBTITLES_API_KEY,
  apiKeyPreview: EMBEDDED_OPENSUBTITLES_API_KEY ? 
    (EMBEDDED_OPENSUBTITLES_API_KEY.slice(0,4) + '****' + EMBEDDED_OPENSUBTITLES_API_KEY.slice(-4)) : 
    '[NONE]',
  buildTime: BUILD_TIMESTAMP
});
`;

  // Ensure directory exists
  const dir = path.dirname(EMBEDDED_CONSTANTS_FILE);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }

  // Write the file
  fs.writeFileSync(EMBEDDED_CONSTANTS_FILE, content, 'utf8');
  
  console.log('‚úÖ Generated embedded constants file:', EMBEDDED_CONSTANTS_FILE);
  console.log('üìä Embedded API keys:', {
    opensubtitles: !!API_KEYS.OPENSUBTITLES_API_KEY ? '‚úÖ Present' : '‚ùå Missing',
    buildTime: timestamp
  });
  
  return {
    file: EMBEDDED_CONSTANTS_FILE,
    hasKeys: !!API_KEYS.OPENSUBTITLES_API_KEY,
    timestamp
  };
}

// Main execution
if (import.meta.url === `file://${process.argv[1]}`) {
  console.log('üîë Embedding API keys at compile time...');
  
  try {
    const result = generateEmbeddedConstants();
    
    if (!result.hasKeys) {
      console.warn('‚ö†Ô∏è  Warning: No API keys found in environment variables');
      console.warn('   Set OPENSUBTITLES_API_KEY environment variable for production builds');
    }
    
    console.log('üéØ Embedded constants generation complete');
    process.exit(0);
  } catch (error) {
    console.error('‚ùå Failed to generate embedded constants:', error.message);
    process.exit(1);
  }
}

export { generateEmbeddedConstants };