#!/usr/bin/env node

/**
 * Generate changelog from GitHub releases
 * This script fetches releases from GitHub API and creates embedded changelog files
 */

import https from 'https';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

console.log('üìù Generating embedded changelog from GitHub releases...');

// Ensure data directory exists
const dataDir = path.join(__dirname, '..', 'src', 'data');
if (!fs.existsSync(dataDir)) {
  fs.mkdirSync(dataDir, { recursive: true });
}

const options = {
  hostname: 'api.github.com',
  path: '/repos/opensubtitles/opensubtitles-uploader-pro/releases',
  headers: {
    'User-Agent': 'OpenSubtitles-Uploader-PRO',
    'Accept': 'application/vnd.github.v3+json'
  }
};

https.get(options, (res) => {
  let data = '';
  res.on('data', (chunk) => data += chunk);
  res.on('end', () => {
    try {
      const releases = JSON.parse(data);
      
      // Filter out drafts and take latest 15 releases
      const validReleases = releases
        .filter(release => !release.draft)
        .slice(0, 15);
      
      const changelog = {
        generated_at: new Date().toISOString(),
        generator: 'OpenSubtitles Uploader PRO Build System',
        total_releases: validReleases.length,
        releases: validReleases.map(release => ({
          version: release.tag_name,
          name: release.name,
          published_at: release.published_at,
          body: release.body || 'No release notes available.',
          html_url: release.html_url,
          prerelease: release.prerelease,
          assets: release.assets.map(asset => ({
            name: asset.name,
            download_url: asset.browser_download_url,
            size: asset.size
          }))
        }))
      };
      
      // Write JSON changelog
      const changelogPath = path.join(dataDir, 'changelog.json');
      fs.writeFileSync(changelogPath, JSON.stringify(changelog, null, 2));
      console.log(`‚úÖ Generated ${changelogPath} with ${changelog.releases.length} releases`);
      
      // Generate markdown changelog
      let markdownContent = '# Changelog\n\n';
      markdownContent += '> This file is automatically generated from GitHub releases during build process\n\n';
      markdownContent += `*Last updated: ${new Date().toLocaleString()}*\n\n`;
      
      changelog.releases.forEach(release => {
        const versionName = release.name ? release.name.replace(release.version + ' - ', '') : '';
        markdownContent += `## ${release.version}${versionName ? ' - ' + versionName : ''}\n\n`;
        markdownContent += `*Released: ${new Date(release.published_at).toLocaleDateString()}*\n\n`;
        
        if (release.prerelease) {
          markdownContent += '**üöß Pre-release**\n\n';
        }
        
        if (release.body && release.body.trim()) {
          markdownContent += release.body + '\n\n';
        }
        
        if (release.assets && release.assets.length > 0) {
          markdownContent += '**Downloads:**\n';
          release.assets.forEach(asset => {
            const sizeKB = Math.round(asset.size / 1024);
            markdownContent += `- [${asset.name}](${asset.download_url}) (${sizeKB} KB)\n`;
          });
          markdownContent += '\n';
        }
        
        markdownContent += '---\n\n';
      });
      
      const changelogMdPath = path.join(__dirname, '..', 'CHANGELOG.md');
      fs.writeFileSync(changelogMdPath, markdownContent);
      console.log(`‚úÖ Generated ${changelogMdPath}`);
      
      console.log('üéâ Changelog generation completed successfully');
      
    } catch (error) {
      console.error('‚ùå Failed to parse GitHub API response:', error);
      process.exit(1);
    }
  });
}).on('error', (error) => {
  console.error('‚ùå Failed to fetch releases from GitHub:', error);
  console.error('   Make sure you have internet connection and GitHub is accessible');
  process.exit(1);
});