name: Generate Changelog

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for changelog generation
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate changelog from GitHub releases
        run: |
          echo "ğŸ“ Generating embedded changelog..."
          
          # Create changelog directory
          mkdir -p src/data
          
          # Generate changelog.json from GitHub API
          node -e "
          const https = require('https');
          const fs = require('fs');
          
          const options = {
            hostname: 'api.github.com',
            path: '/repos/opensubtitles/opensubtitles-uploader-pro/releases',
            headers: {
              'User-Agent': 'OpenSubtitles-Uploader-PRO',
              'Accept': 'application/vnd.github.v3+json'
            }
          };
          
          https.get(options, (res) => {
            let data = '';
            res.on('data', (chunk) => data += chunk);
            res.on('end', () => {
              try {
                const releases = JSON.parse(data);
                const changelog = {
                  generated_at: new Date().toISOString(),
                  releases: releases.slice(0, 10).map(release => ({
                    version: release.tag_name,
                    name: release.name,
                    published_at: release.published_at,
                    body: release.body || 'No release notes available.',
                    html_url: release.html_url,
                    prerelease: release.prerelease,
                    draft: release.draft
                  }))
                };
                
                fs.writeFileSync('src/data/changelog.json', JSON.stringify(changelog, null, 2));
                console.log('âœ… Generated changelog with', changelog.releases.length, 'releases');
                
                // Also create a markdown version
                let markdownContent = '# Changelog\\n\\n';
                markdownContent += '> This file is automatically generated from GitHub releases\\n\\n';
                
                changelog.releases.forEach(release => {
                  markdownContent += '## ' + release.version + (release.name ? ' - ' + release.name.replace(release.version + ' - ', '') : '') + '\\n\\n';
                  markdownContent += '*Released: ' + new Date(release.published_at).toLocaleDateString() + '*\\n\\n';
                  if (release.body && release.body.trim()) {
                    markdownContent += release.body + '\\n\\n';
                  }
                  markdownContent += '---\\n\\n';
                });
                
                fs.writeFileSync('CHANGELOG.md', markdownContent);
                console.log('âœ… Generated CHANGELOG.md');
                
              } catch (error) {
                console.error('âŒ Failed to parse GitHub API response:', error);
                process.exit(1);
              }
            });
          }).on('error', (error) => {
            console.error('âŒ Failed to fetch releases from GitHub:', error);
            process.exit(1);
          });
          "
      
      - name: Verify changelog files
        run: |
          echo "ğŸ“‹ Verifying generated files..."
          if [ -f "src/data/changelog.json" ]; then
            echo "âœ… changelog.json created ($(wc -l < src/data/changelog.json) lines)"
            echo "ğŸ“Š Preview:"
            head -20 src/data/changelog.json
          else
            echo "âŒ changelog.json not found"
            exit 1
          fi
          
          if [ -f "CHANGELOG.md" ]; then
            echo "âœ… CHANGELOG.md created ($(wc -l < CHANGELOG.md) lines)"
          else
            echo "âŒ CHANGELOG.md not found"
            exit 1
          fi
      
      - name: Upload changelog artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-changelog
          path: |
            src/data/changelog.json
            CHANGELOG.md
          retention-days: 90